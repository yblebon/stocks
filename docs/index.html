<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>"The Financier"</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* Custom styles for better readability and structure */
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 1100px;
        }
        #dataTable th, #dataTable td {
            text-align: right;
        }
        #dataTable th:first-child, #dataTable td:first-child {
            text-align: left;
        }
        /* Custom radio button appearance */
        .radio-label input[type="radio"]:checked + span {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">

    <div class="container mx-auto">
        <header class="text-center py-6 bg-white shadow-md rounded-lg mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Rule Number One: Fuck What They Think</h1>
            <p class="text-gray-500 mt-2">Click a file to load the JSON content, display the raw data, and plot the historical trend.</p>
        </header>
        
        <!-- File Listing Section -->
        <section class="mb-8 bg-white p-6 shadow-lg rounded-lg">
            <h2 class="text-2xl font-semibold border-b pb-2 mb-4 text-gray-700">Available Data Files</h2>
            <div id="loading" class="text-blue-500">Loading file list...</div>
            <ul id="fileList" class="list-none p-0 space-y-2"></ul>
            <div id="error-message" class="text-red-500 mt-4 hidden"></div>
        </section>

        <!-- Visualization Section -->
        <section id="table-container" class="bg-white p-6 shadow-lg rounded-lg">
            <h2 class="text-2xl font-semibold border-b pb-2 mb-4 text-gray-700">Data Visualization</h2>
            <p id="currentFileDisplay" class="text-gray-500 mb-6">Click a file above to load the data.</p>

            <!-- Chart Container -->
            <div id="chart-wrapper" class="hidden">
                <div id="dataSelector" class="mb-4 flex flex-wrap gap-3 justify-center">
                    <!-- Radio buttons for selecting data series will be inserted here -->
                </div>
                <div class="h-96 w-full p-4 border rounded-lg bg-gray-50">
                    <canvas id="timeSeriesChart"></canvas>
                </div>
            </div>

            <!-- Table Output -->
            <h3 class="text-xl font-medium mt-8 mb-4 text-gray-700">Raw Data Table</h3>
            <div id="dataOutput" class="overflow-x-auto">
                <!-- Table will be inserted here -->
            </div>
        </section>
    </div>

    <script type="module" src="./config.js"></script> 

    <script type="module">
        import GITHUB_CONFIG from './config.js';

        // 3. Use the imported config values
        const owner = GITHUB_CONFIG.owner; 
        const repo = GITHUB_CONFIG.repo;
        const path = GITHUB_CONFIG.path;

        const baseApiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        
        const fileListElement = document.getElementById('fileList');
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error-message');
        const dataOutputElement = document.getElementById('dataOutput');
        const currentFileDisplay = document.getElementById('currentFileDisplay');
        const chartWrapper = document.getElementById('chart-wrapper');
        const dataSelector = document.getElementById('dataSelector');

        let chartInstance = null;
        let currentChartData = {};

        /**
         * Converts a Unix millisecond timestamp to a human-readable date string.
         * @param {string} timestamp The timestamp string (e.g., "1761523200000").
         * @returns {string} The formatted date string.
         */
        function formatTimestamp(timestamp) {
            const date = new Date(Number(timestamp));
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        /**
         * Renders the Chart.js chart for a selected data metric.
         * @param {string} metric The metric to plot (e.g., 'Close', 'Open').
         */
        function renderChart(metric) {
            const { labels, datasets } = currentChartData;
            const dataToPlot = datasets[metric];
            const canvas = document.getElementById('timeSeriesChart');

            if (!dataToPlot) return;

            // Destroy the previous chart instance if it exists
            if (chartInstance) {
                chartInstance.destroy();
            }

            const ctx = canvas.getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${metric} Price Over Time`,
                        data: dataToPlot,
                        borderColor: '#3b82f6', // blue-500
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        tension: 0.2, // Smooth lines
                        borderWidth: 2,
                        pointRadius: 0 // Hide points for clean line graph
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: `${metric} Price History`
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                maxTicksLimit: 10 // Prevent cluttering the axis
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: metric === 'Volume' ? 'Volume' : 'Value'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Processes raw JSON data into Chart.js format and renders the chart/table.
         * @param {Object} rawData The parsed JSON object.
         * @param {string} fileName The name of the file being processed.
         */
        function processAndDisplayData(rawData, fileName) {
            const keys = Object.keys(rawData);
            if (keys.length === 0) {
                dataOutputElement.innerHTML = '<p>The file is empty or does not contain valid data entries.</p>';
                chartWrapper.classList.add('hidden');
                return;
            }

            // --- 1. Data Processing for Chart and Table ---
            const firstEntry = rawData[keys[0]];
            const dataProperties = Object.keys(firstEntry).filter(p => p !== 'Dividends' && p !== 'Stock Splits'); // Filter out zeroed columns
            
            const chartLabels = [];
            const chartDatasets = {};

            // Initialize dataset arrays
            dataProperties.forEach(prop => {
                chartDatasets[prop] = [];
            });

            // Populate labels and datasets
            keys.forEach(timestamp => {
                chartLabels.push(formatTimestamp(timestamp)); // Date label
                const entry = rawData[timestamp];
                dataProperties.forEach(prop => {
                    chartDatasets[prop].push(entry[prop]);
                });
            });

            currentChartData = {
                labels: chartLabels,
                datasets: chartDatasets
            };

            // --- 2. Render Chart Selector ---
            dataSelector.innerHTML = ''; // Clear existing buttons
            dataProperties.forEach((metric, index) => {
                const radioId = `metric-${metric.toLowerCase().replace(' ', '-')}`;
                const isDefaultChecked = metric === 'Close'; // Default to plotting Close price

                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'chartMetric';
                input.id = radioId;
                input.value = metric;
                input.checked = isDefaultChecked;
                input.classList.add('hidden'); // Hide default radio button
                
                input.onchange = () => renderChart(metric);

                const label = document.createElement('label');
                label.htmlFor = radioId;
                label.classList.add('radio-label', 'cursor-pointer');
                label.innerHTML = `<span class="px-4 py-2 text-sm border border-gray-300 rounded-full transition-colors duration-150">${metric}</span>`;
                
                dataSelector.appendChild(label);
            });

            // --- 3. Render Initial Chart (Default: Close) ---
            chartWrapper.classList.remove('hidden');
            renderChart('Close');

            // --- 4. Render Table ---
            createTable(rawData, fileName, ['Date', ...dataProperties]);
        }


        /**
         * Builds an HTML table from the JSON content object.
         * @param {Object} data The parsed JSON object.
         * @param {string} fileName The name of the file being processed.
         * @param {Array<string>} headers The column headers for the table.
         */
        function createTable(data, fileName, headers) {
            // Clear previous content
            dataOutputElement.innerHTML = '';
            currentFileDisplay.textContent = `Displaying data for: ${fileName}`;

            let tableHTML = '<table id="dataTable" class="min-w-full divide-y divide-gray-200 border border-gray-200">';
            
            // Table Header
            tableHTML += '<thead class="bg-gray-50"><tr>';
            headers.forEach(header => {
                tableHTML += `<th scope="col" class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`;
            });
            tableHTML += '</tr></thead>';

            // Table Body
            tableHTML += '<tbody class="bg-white divide-y divide-gray-200">';

            const timestamps = Object.keys(data);
            timestamps.forEach(timestamp => {
                const entry = data[timestamp];
                const dateString = formatTimestamp(timestamp);
                
                tableHTML += '<tr>';
                tableHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${dateString}</td>`; 
                
                headers.slice(1).forEach(prop => {
                    const value = entry[prop] !== undefined ? entry[prop].toLocaleString() : 'N/A';
                    tableHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${value}</td>`; 
                });
                
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            dataOutputElement.innerHTML = tableHTML;
        }


        /**
         * Fetches and processes the content of a specific file.
         * @param {string} rawUrl The raw file URL from GitHub.
         * @param {string} fileName The name of the file.
         */
        async function readFileAndCreateTable(rawUrl, fileName) {
            dataOutputElement.innerHTML = '<p class="text-gray-500">Loading file content...</p>';
            currentFileDisplay.textContent = `Loading data for: ${fileName}`;

            try {
                const response = await fetch(rawUrl);

                if (!response.ok) {
                    throw new Error(`Failed to fetch raw file: ${response.status} ${response.statusText}`);
                }

                const rawContent = await response.text();
                
                // Parse the JSON string into a JavaScript object
                const data = JSON.parse(rawContent);

                processAndDisplayData(data, fileName);

            } catch (error) {
                dataOutputElement.innerHTML = `<p class="text-red-500">Error processing file. Ensure it is valid JSON in the expected format. Error: ${error.message}</p>`;
                console.error(`Error processing ${fileName}:`, error);
                chartWrapper.classList.add('hidden');
            }
        }

        /**
         * Fetches the initial directory listing from GitHub.
         */
        async function listDirectoryContents() {
            try {
                const response = await fetch(baseApiUrl);

                if (!response.ok) {
                    throw new Error(`GitHub API Error: ${response.status} ${response.statusText}`);
                }

                const contents = await response.json();
                loadingElement.classList.add('hidden');

                if (Array.isArray(contents) && contents.length > 0) {
                    // Filter for files that look like data files (ending in .json)
                    const files = contents
                        .filter(item => item.type === 'file' && item.name.toLowerCase().endsWith('.json'))
                        .sort((a, b) => a.name.localeCompare(b.name));
                    
                    if (files.length === 0) {
                        fileListElement.innerHTML = '<li class="text-gray-500">No JSON files found in this directory.</li>';
                        return;
                    }

                    files.forEach(item => {
                        const listItem = document.createElement('li');
                        const button = document.createElement('button');
                        
                        // Apply Tailwind classes for button styling
                        button.textContent = item.name;
                        button.classList.add('text-blue-600', 'hover:text-blue-800', 'font-medium', 'transition-colors', 'duration-150', 'text-left', 'w-full', 'p-1');
                        
                        // Set the click handler
                        button.onclick = () => readFileAndCreateTable(item.download_url, item.name);

                        listItem.appendChild(button);
                        fileListElement.appendChild(listItem);
                    });
                } else {
                    fileListElement.innerHTML = '<li class="text-gray-500">Directory is empty or path is invalid.</li>';
                }

            } catch (error) {
                loadingElement.classList.add('hidden');
                errorElement.textContent = `Failed to load contents. Error: ${error.message}`;
                errorElement.classList.remove('hidden');
                console.error('Error fetching GitHub contents:', error);
            }
        }

        listDirectoryContents();
    </script>

</body>
</html>